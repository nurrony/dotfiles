# ==========================================================================
# Core configuration
# ==========================================================================

# Prefix key (more ergonomic than default C-b)
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# Zero delay for ESC â€” critical for Neovim
set -s escape-time 0

# Use 1-based indexing
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Scrollback
set -g history-limit 5000

# Terminal & colors (truecolor, undercurl friendly)
set -g default-terminal "tmux-256color"
set -as terminal-features ",*:RGB"

# Undercurl support
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Mouse support
set -g mouse on

# Terminal title
set -g set-titles on

# Focus events (important for Neovim)
set -g focus-events on

# Resize panes aggressively when clients differ in size
setw -g aggressive-resize on

# Do not auto-rename windows
set -g allow-rename off

# Do not detach when session is destroyed
set -g detach-on-destroy off

# Disable all bells & visual noise
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
setw -g monitor-activity off
set -g bell-action none

# ==========================================================================
# Key bindings
# ==========================================================================

# Reload config
unbind r
bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"

# Window navigation (repeatable)
bind -r n next-window
bind -r p previous-window
bind C-n next-window
bind C-p previous-window
bind Space last-window

# Session switch (last)
bind b switch-client -l

# Pane navigation (Vim-style, repeatable)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Pane resizing (repeatable)
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5

bind -r C-H resize-pane -L 5
bind -r C-L resize-pane -R 5
bind -r C-J resize-pane -D 5
bind -r C-K resize-pane -U 5

# Move windows left/right
bind -r N swap-window -t +1
bind -r P swap-window -t -1

# Split panes (preserve cwd)
unbind '"'
unbind %
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Break / join panes
bind B break-pane -d
bind E command-prompt -p "join pane from: " "join-pane -h -s '%%'"

# Kill window by prompt
bind X command-prompt -p "kill window: " "kill-window -t '%%'"

# Clipboard (macOS)
bind y run -b "tmux show-buffer | pbcopy" \; display-message "Copied to clipboard"

# Open lazygit
bind g new-window -n lazygit -c "#{pane_current_path}" "lazygit"

# Open arbitrary app
bind o command-prompt -p "open app: " "new-window '%%'"

# Session picker (fzf popup)
bind C-e display-popup -E "\
  tmux list-sessions -F '#{?session_attached,,#{session_name}}' | \
  sed '/^$/d' | \
  fzf --reverse --header jump-to-session | \
  xargs tmux switch-client -t"

# ==========================================================================
# Theme (minimal, clean)
# ==========================================================================

setw -g clock-mode-colour colour1
setw -g mode-style 'fg=colour1 bg=colour18 bold'

set -g pane-border-style 'fg=colour1'
set -g pane-active-border-style 'fg=colour3'

set -g status-position bottom
set -g status-justify left
set -g status-style 'fg=green'
set -g status-left ''
set -g status-right ''
set -g status-left-length 50
set -g status-right-length 0

setw -g window-status-current-style 'fg=colour0 bg=colour1 bold'
setw -g window-status-current-format ' #I #W #F '

setw -g window-status-style 'fg=colour1 dim'
setw -g window-status-format ' #I #[fg=colour7]#W #[fg=colour1]#F '

setw -g window-status-bell-style 'fg=colour2 bg=colour1 bold'

set -g message-style 'fg=white bg=colour8 bold'

# ==========================================================================
# Plugins
# ==========================================================================

set -g @plugin 'tmux-plugins/tpm'

# Seamless Neovim <-> tmux navigation
# set -g @plugin 'christoomey/vim-tmux-navigator'

# Session persistence
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
set -g @resurrect-strategy-nvim 'session'

# Initialize TPM (must be last)
run '~/.config/tmux/plugins/tpm/tpm'
